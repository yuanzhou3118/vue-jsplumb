(function(t){function e(e){for(var a,o,l=e[0],r=e[1],c=e[2],u=0,h=[];u<l.length;u++)o=l[u],Object.prototype.hasOwnProperty.call(s,o)&&s[o]&&h.push(s[o][0]),s[o]=0;for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(t[a]=r[a]);d&&d(e);while(h.length)h.shift()();return n.push.apply(n,c||[]),i()}function i(){for(var t,e=0;e<n.length;e++){for(var i=n[e],a=!0,l=1;l<i.length;l++){var r=i[l];0!==s[r]&&(a=!1)}a&&(n.splice(e--,1),t=o(o.s=i[0]))}return t}var a={},s={app:0},n=[];function o(e){if(a[e])return a[e].exports;var i=a[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=t,o.c=a,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)o.d(i,a,function(e){return t[e]}.bind(null,a));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="";var l=window["webpackJsonp"]=window["webpackJsonp"]||[],r=l.push.bind(l);l.push=e,l=l.slice();for(var c=0;c<l.length;c++)e(l[c]);var d=r;n.push([0,"chunk-vendors"]),i()})({0:function(t,e,i){t.exports=i("56d7")},"0aaf":function(t,e,i){"use strict";var a=i("3027"),s=i.n(a);s.a},"1d9f":function(t,e,i){},"245a":function(t,e,i){"use strict";i.r(e);var a=i("96eb"),s=i.n(a);s.a.mock("/folder/all",/get|post/i,{status:200,message:"success",data:{total:1,list:[{id:"1",name:"菜单1"}]}}),s.a.mock("/job","post",{}),s.a.mock("/job","put",{}),s.a.mock("/job/all","get",{}),s.a.mock(RegExp("/job/.*"),"delete",{}),s.a.mock("/job/run","post",{}),s.a.mock(RegExp("/job/stop/.*"),"get",{}),s.a.mock(RegExp("/job/echo/.*"),"get",{}),s.a.mock("/getTableHeadList","get",{})},2476:function(t,e,i){"use strict";var a=i("1d9f"),s=i.n(a);s.a},3027:function(t,e,i){},3724:function(t,e,i){},"42c6":function(t,e,i){"use strict";var a=i("eb88"),s=i.n(a);s.a},"49d2":function(t,e,i){t.exports=i.p+"img/no-task.36239238.png"},"4a4d":function(t,e,i){},"56d7":function(t,e,i){"use strict";i.r(e);var a=i("2b0e"),s=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{attrs:{id:"app"}},[i("header",[t._v("vue-jsplumb")]),i("PanelIndex")],1)},n=[],o=function(){var t=this,e=this,i=e.$createElement,a=e._self._c||i;return a("div",{staticClass:"panel"},[a("Drawer",{attrs:{mode:"left",visible:e.isShowNodeMenu,width:"3.2"},on:{"update:visible":function(t){e.isShowNodeMenu=t}}},[a("div",{staticClass:"left-part"},[a("div",{staticClass:"panel__title"},[e._v("数据源")]),a("nodeMenu",{ref:"nodeMenu",attrs:{status:this.canvasTabList.find((function(e){return e.id==t.canvasActiveId}))&&this.canvasTabList.find((function(e){return e.id==t.canvasActiveId})).status},on:{addNode:e.addNode}})],1)]),a("div",{staticClass:"panel-container"},[a("div",{staticClass:"panel-container__title"},[a("div",{staticClass:"notice-for-new",class:{active:e.isShowNewTaskNotice}},[e._v(" 操作说明： "),e._m(0)]),a("el-tabs",{staticClass:"panel-container__tabs",attrs:{type:"card",closable:""},model:{value:e.canvasActiveId,callback:function(t){e.canvasActiveId=t},expression:"canvasActiveId"}},[e._l(e.canvasTabList,(function(t,i){return a("el-tab-pane",{key:t.name,attrs:{name:""+t.id}},[a("div",{staticClass:"edit-label",attrs:{slot:"label"},slot:"label"},[a("span",{staticClass:"edit-label-content"},[e._v(e._s(t.name))]),a("span",[e.canvasActiveId!=t.id||t.status?e._e():a("el-popover",{ref:"editCanvasName",refInFor:!0,attrs:{"popper-class":"edit-label-name-popover",value:e.editCanvasNamePopover,placement:"bottom",title:"编辑任务名称",width:"320","popper-options":{boundariesElement:".panel-container",gpuAcceleration:!1},trigger:"manual"},on:{show:function(i){return e.handleCanvasNamePopover(t.label)}}},[a("el-form",{ref:"rulesForm",refInFor:!0,attrs:{model:e.nameValidateForm,rules:e.rules},nativeOn:{submit:function(t){t.preventDefault()}}},[a("el-form-item",{attrs:{prop:"name"}},[a("el-input",{attrs:{maxlength:10,placeholder:"请输入任务名称"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.editCanvasName(i)}},model:{value:e.nameValidateForm.name,callback:function(t){e.$set(e.nameValidateForm,"name",t)},expression:"nameValidateForm.name"}})],1),a("el-form-item",{staticStyle:{margin:"0","text-align":"right"}},[a("el-button",{on:{click:function(t){e.editCanvasNamePopover=!1}}},[e._v("取消")]),a("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.editCanvasName(i)}}},[e._v("确定")])],1)],1),e.canvasActiveId!=t.id||t.status?e._e():a("i",{staticClass:"el-icon-edit",attrs:{slot:"reference"},on:{click:function(i){return e.toggleEditCanvasNamePopover(t.name)}},slot:"reference"})],1),a("i",{staticClass:"el-icon-close",on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.removeTab(i)}}})],1)]),a("div",{directives:[{name:"flowDrag",rawName:"v-flowDrag"}],staticClass:"tab-pane-container",staticStyle:{width:"100%",height:"100%"},on:{mousewheel:function(t){return t.stopPropagation(),t.preventDefault(),e.mouseWheelAction(t)}}},[t.id==e.canvasActiveId?a("div",{ref:"flowContainer_"+t.id,refInFor:!0,staticClass:"container flowContainer",style:{"-webkit-transform":"scale("+t.zoom+")","-moz-transform":"scale("+t.zoom+")","-ms-transform":"scale("+t.zoom+")","-o-transform":"scale("+t.zoom+")",transform:"scale("+t.zoom+")"},attrs:{id:"flowContainer_"+t.id}},[e._l(t.data.nodeList,(function(i){return[a("flowNode",{key:i.id,attrs:{activeElement:e.activeElement,node:i,status:t.status,data:t.data},on:{deleteElement:e.deleteElement,changeNodeSite:e.changeNodeSite,nodeRightMenu:e.nodeRightMenu,openPreview:e.openPreview,clickNode:e.clickNode}})]}))],2):e._e()])])})),e.canvasTabList.length>0?a("el-tab-pane",{key:"close",attrs:{disabled:"",name:"close",closable:!1}},[a("div",{staticClass:"el-button el-button--danger el-button--mini",attrs:{slot:"label"},on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.closeAllTab(t)}},slot:"label"},[e._v(" 全部关闭 ")])]):e._e(),a("el-tab-pane",{key:"add",attrs:{disabled:"",name:"add",closable:!1}},[a("div",{attrs:{slot:"label"},on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.addTab(t)}},slot:"label"},[a("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"添加标签页",placement:"bottom"}},[a("i",{staticClass:"el-data-collision-add-tabs"})])],1)])],2),a("div",{ref:"calculators",staticClass:"result-component",class:this.canvasTabList.find((function(e){return e.id==t.canvasActiveId}))&&this.canvasTabList.find((function(e){return e.id==t.canvasActiveId})).status?"readOnly":""},[[a("draggable",{attrs:{draggable:this.canvasTabList.find((function(e){return e.id==t.canvasActiveId}))&&this.canvasTabList.find((function(e){return e.id==t.canvasActiveId})).status?null:".moveCalculator",options:e.draggableOptions},on:{end:e.endCalculators},model:{value:e.calculators,callback:function(t){e.calculators=t},expression:"calculators"}},e._l(e.calculators,(function(t){return a("div",{key:t.name,class:["result-component__item",{moveCalculator:"link"!==t.type}]},[a("i",{class:"result-component__icon "+t.icon}),e._v(" "+e._s(t.label)+" ")])})),0)]],2),this.canvasTabList.find((function(e){return e.id==t.canvasActiveId}))&&this.canvasTabList.find((function(e){return e.id==t.canvasActiveId})).data.nodeList.length>0?a("div",{directives:[{name:"show",rawName:"v-show",value:!e.isFullScreen,expression:"!isFullScreen"}],staticClass:"flow-button-group"},[this.canvasTabList.find((function(e){return e.id==t.canvasActiveId}))&&!this.canvasTabList.find((function(e){return e.id==t.canvasActiveId})).status?a("div",{staticClass:"flow-button-group__item",on:{click:function(t){return t.stopPropagation(),e.resetFlowContainer(t)}}},[a("svg",{staticClass:"icon",attrs:{t:"1595660240940",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"2636",width:"200",height:"200"}},[a("path",{attrs:{d:"M983.964 953.145 846.307 953.145c-21.721 0-39.33-17.575-39.33-39.249L806.977 796.141c0-21.677 17.609-39.249 39.33-39.249l39.33 0L885.637 580.263c0-21.679-17.607-39.251-39.33-39.251L531.664 541.012l0 215.88 39.332 0c21.721 0 39.33 17.572 39.33 39.249l0 117.756c0 21.674-17.609 39.249-39.33 39.249L433.34 953.146c-21.723 0-39.33-17.575-39.33-39.249L394.01 796.141c0-21.677 17.607-39.249 39.33-39.249l39.33 0 0-215.88L177.693 541.012c-21.721 0-39.33 17.572-39.33 39.251l0 176.629 39.33 0c21.721 0 39.33 17.572 39.33 39.249l0 117.756c0 21.674-17.609 39.249-39.33 39.249L40.036 953.146c-21.721 0-39.33-17.575-39.33-39.249L0.706 796.141c0-21.677 17.609-39.249 39.33-39.249l39.33 0L79.366 560.636c0-43.355 35.219-78.502 78.663-78.502L472.67 482.134 472.67 266.257l-39.33 0c-21.723 0-39.33-17.575-39.33-39.253L394.01 109.252c0-21.679 17.607-39.251 39.33-39.251l137.657 0c21.721 0 39.33 17.572 39.33 39.251l0 117.751c0 21.679-17.609 39.253-39.33 39.253l-39.332 0 0 215.878 334.309 0c43.441 0 78.66 35.147 78.66 78.502l0 196.255 39.33 0c21.721 0 39.33 17.572 39.33 39.249l0 117.756C1023.294 935.571 1005.684 953.145 983.964 953.145z","p-id":"2637"}})])]):e._e(),a("div",{staticClass:"flow-button-group__item",class:{disabled:!e.isCanZoomAdd},on:{click:function(t){t.stopPropagation(),e.isCanZoomAdd&&e.zoomAdd()}}},[a("svg",{staticClass:"icon",attrs:{t:"1595660649648",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"7457",width:"200",height:"200"}},[a("path",{attrs:{d:"M926.72 829.44q28.672 32.768 31.232 57.344t-18.944 48.128q-24.576 27.648-54.272 26.112t-57.344-24.064l-164.864-158.72q-46.08 30.72-99.84 47.616t-113.152 16.896q-80.896 0-151.552-30.72t-123.392-83.456-82.944-123.392-30.208-151.552q0-79.872 30.208-150.528t82.944-123.392 123.392-83.456 151.552-30.72 151.552 30.72 123.392 83.456 83.456 123.392 30.72 150.528q0 61.44-17.92 116.736t-49.664 101.376q13.312 14.336 37.376 38.4t48.128 48.64 44.544 44.032zM449.536 705.536q53.248 0 100.352-19.968t81.92-54.784 54.784-81.92 19.968-100.352-19.968-100.352-54.784-81.92-81.92-54.784-100.352-19.968-99.84 19.968-81.408 54.784-55.296 81.92-20.48 100.352 20.48 100.352 55.296 81.92 81.408 54.784 99.84 19.968zM512 384l128 0 0 128-128 0 0 128-129.024 0 0-128-126.976 0 0-128 126.976 0 0-128 129.024 0 0 128z","p-id":"7458"}})])]),a("div",{staticClass:"flow-button-group__item",class:{disabled:!e.isCanZoomMinus},on:{click:function(t){t.stopPropagation(),e.isCanZoomMinus&&e.zoomMinus()}}},[a("svg",{staticClass:"icon",attrs:{t:"1595660656545",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"7595",width:"200",height:"200"}},[a("path",{attrs:{d:"M927.744 829.44q28.672 32.768 31.232 57.344t-18.944 48.128q-24.576 27.648-54.272 26.112t-57.344-24.064l-164.864-157.696q-46.08 29.696-99.84 46.592t-113.152 16.896q-80.896 0-151.552-30.72t-123.392-83.456-82.944-123.392-30.208-151.552q0-79.872 30.208-150.528t82.944-123.392 123.392-83.456 151.552-30.72 151.552 30.72 123.392 83.456 83.456 123.392 30.72 150.528q0 61.44-17.92 116.736t-49.664 102.4l36.864 37.888q24.576 23.552 48.64 48.128t43.52 44.032zM450.56 705.536q53.248 0 100.352-19.968t81.92-54.784 54.784-81.92 19.968-100.352-19.968-100.352-54.784-81.92-81.92-54.784-100.352-19.968-99.84 19.968-81.408 54.784-55.296 81.92-20.48 100.352 20.48 100.352 55.296 81.92 81.408 54.784 99.84 19.968zM256 384l385.024 0 0 128-385.024 0 0-128z","p-id":"7596"}})])])]):e._e(),a("div",{staticClass:"button-group"},[a("el-button",{attrs:{disabled:!e.isCanClear,type:"warning"},on:{click:e.clearCanvas}},[e._v("清除画布")])],1)],1)]),a("Drawer",{attrs:{mode:"right",visible:e.isShowTaskList,width:"3.6"},on:{"update:visible":function(t){e.isShowTaskList=t},open:e.openTaskList}},[a("div",{staticClass:"right-part"},[a("task-list",{ref:"taskList",attrs:{tabs:e.canvasTabList,canvasLoading:e.canvasLoading,activeJobId:e.canvasActiveId},on:{removeRepeatTaskTab:e.removeRepeatTaskTab,changeTab:e.changeTab,"update:canvasLoading":function(t){e.canvasLoading=t},"update:canvas-loading":function(t){e.canvasLoading=t},updateTaskTotal:e.updateTaskTotal,previewTask:e.previewTaskDetail}})],1)]),e.calculatorDialogVisible?a("calculator-dialog",{attrs:{data:e.calculatorDialogData,status:this.canvasTabList.find((function(e){return e.id==t.canvasActiveId}))&&this.canvasTabList.find((function(e){return e.id==t.canvasActiveId})).status,calculatorDialogVisible:e.calculatorDialogVisible},on:{confirm:e.handleCalculatorData,"update:calculatorDialogVisible":function(t){e.calculatorDialogVisible=t},"update:calculator-dialog-visible":function(t){e.calculatorDialogVisible=t}}}):e._e()],1)},l=[function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("ul",[i("li",[t._v("1、拖拽左侧数据源到此画布；")]),i("li",[t._v("2、拖拽交并集操作按钮；")]),i("li",[t._v("3、连接算子与数据表；")]),i("li",[t._v("4、设置关联关系；")]),i("li",[t._v("5、拖拽输出至画布，且连接完成；")]),i("li",[t._v("6、点击“运行”。")])])}],r=i("310e"),c=i.n(r),d=i("e193"),u=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"drawer-component",class:["mode-"+t.mode,{"is-open":t.visible,"is-close":!t.visible}],style:t.style},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.visible,expression:"visible"}],staticClass:"drawer-component__container"},[t._t("default")],2),i("div",{staticClass:"drawer-trigger",class:"drawer-"+t.mode,on:{click:t.toggerDrawer}},[i("i",{staticClass:"el-icon-arrow-left"})])])},h=[],p={name:"Drawer",props:{width:{type:String,default:"3"},height:{type:String,default:"3"},mode:{type:String,default:"left"},visible:{type:Boolean,default:!0},zIndex:{type:String,default:"3"}},computed:{style(){return{"z-index":this.zIndex,width:"bottom"==this.mode?"100%":this.width+"rem",height:"bottom"!==this.mode?"100%":this.height+"rem"}}},data(){return{}},methods:{toggerDrawer(){const t=!this.visible;this.$emit("update:visible",t),t?this.$emit("open"):this.$emit("close")}}},f=p,m=(i("f4f4"),i("2877")),v=Object(m["a"])(f,u,h,!1,null,"09d10952",null),g=v.exports,b=i("bc3a"),L=i.n(b);function y(t,e){return new Promise((i,a)=>{L()({method:"post",url:t,data:e||""}).then(t=>{(void 0).$judgeCodeState(t)?i(t.data):a(t.data)}).catch(t=>{a(t)})})}function C(t,e){let i=e;return e&&""!==e||(i=""),new Promise((e,a)=>{L()({method:"delete",url:t+i}).then(t=>{(void 0).$judgeCodeState(t)?e(t.data):a(t.data)}).catch(t=>{a(t)})})}function w(t,e){return new Promise((i,a)=>{L()({method:"put",url:t,data:e||""}).then(t=>{(void 0).$judgeCodeState(t)?i(t.data):a(t.data)}).catch(t=>{a(t)})})}function k(t,e){return new Promise((i,a)=>{L()({method:"get",url:t,params:e||{}}).then(t=>{(void 0).$judgeCodeState(t)?i(t.data):a(t.data)}).catch(t=>{a(t)})})}L.a.interceptors.response.use(t=>(console.log("response",t),Promise.resolve(t.data)),t=>Promise.reject(t));const T=t=>k("/folder/all",t),x=t=>y("/job",t),I=t=>w("/job",t),O=t=>k("/job/all",t),_=t=>C("/job/"+t),P=t=>k("/job/stop/"+t),j=t=>k("/job/echo/"+t),D=t=>k("/getTableHeadList",t),E={data(){return{jsplumbSetting:{Anchors:["Top","TopCenter","TopRight","TopLeft","Right","RightMiddle","Bottom","BottomCenter","BottomRight","BottomLeft","Left","LeftMiddle"],Connector:["Flowchart",{stub:30,gap:1,alwaysRespectStubs:!1,midpoint:.5,cornerRadius:10}],ConnectionsDetachable:!1,DeleteEndpointsOnDetach:!1,Endpoint:["Blank",{Overlays:""}],LogEnabled:!0,PaintStyle:{stroke:"#1890FF",strokeWidth:1,outlineStroke:"transparent",outlineWidth:10},DragOptions:{cursor:"pointer",zIndex:2e3},setDragAllowedWhenFull:!0,Overlays:[["Arrow",{width:10,length:8,location:1,direction:1,foldback:1}],["Label",{label:"",location:.1,cssClass:"aLabel"}]],RenderMode:"svg",Scope:"jsPlumb_DefaultScope"},jsplumbConnectOptions:{isSource:!0,isTarget:!0,anchor:"Continuous"},jsplumbSourceOptions:{filter:".flow-node-drag",filterExclude:!1,anchor:"Continuous",allowLoopback:!1,maxConnections:1,onMaxConnections:function(t,e){console.log("超过了最大值连线: "+t.maxConnections)}},jsplumbSourceOptions2:{filter:".flow-node-drag",filterExclude:!1,allowLoopback:!1,connector:["Flowchart",{curviness:50}],connectorStyle:{stroke:"red",strokeWidth:1,outlineStroke:"transparent",outlineWidth:10},connectorHoverStyle:{stroke:"red",strokeWidth:2}},jsplumbTargetOptions:{filter:".flow-node-drag",filterExclude:!1,anchor:"Continuous",allowLoopback:!1,dropOptions:{hoverClass:"drop-hover"}}}}};var S=i("5c96"),$=i.n(S),N=i("e4fd"),F=i.n(N);function R(t){const e=[];return t.forEach(t=>{e.push({sourceEle:parseInt(t.from),targetEle:parseInt(t.to)})}),e}function M(t){const e=[];return t.forEach(t=>{e.push({sourceId:t.sourceColId,targetId:t.targetColId})}),e}function A(t,e,i){let a=[],s=null;const n=e.find(t=>1==t.type);let o=null;if(o=n?t.find(t=>t.sourceEle==i&&t.targetEle!==n.id):t.find(t=>t.sourceEle==i),o){const t=e.find(t=>t.id==o.targetEle),{daCoRelColContentList:n}=t;if(n){const t=n.find(t=>t.fromEleId==i);if(t){if(0==t.type){s="left";const t=n.filter(t=>0==t.type);t.forEach(t=>{a.push({...t,rename:t.rename||t.name})})}if(1==t.type){s="right";const t=n.filter(t=>1==t.type);t.forEach(t=>{a.push({...t,rename:t.rename||t.name})})}}}}return{field:a,rightOrLeft:s}}function z(t){const e=[];return t.forEach(t=>{e.push({sourceColId:""+t.sourceId,targetColId:""+t.targetId})}),e}function B({elementList:t,elementRelList:e}){const i={nodeList:[],lineList:[]},{nodeList:a,lineList:s}=i;return t.forEach(i=>{switch(i.type){case 0:a.push({type:"table",name:i.dbTableName,tableId:i.metaTableId,id:i.id,top:i.y+"px",left:i.x+"px",ico:"",...A(e,t,i.id),sourceMap:null,condition:i.tableConditionList});break;case 1:a.push({type:"export",name:"输出",tableId:i.metaTableId,id:""+i.id,top:i.y+"px",left:i.x+"px",field:[],ico:"",rightOrLeft:null,sourceMap:null,condition:i.tableConditionList});break;case 2:a.push({type:"calculators",name:"并集",tableId:i.metaTableId,id:""+i.id,ico:"",top:i.y+"px",left:i.x+"px",...A(e,t,i.id),sourceMap:z(i.daCoRelColRelationList),condition:i.tableConditionList});break;case 3:a.push({type:"calculators",name:"交集",ico:"",tableId:i.metaTableId,id:""+i.id,top:i.y+"px",left:i.x+"px",...A(e,t,i.id),sourceMap:z(i.daCoRelColRelationList),condition:i.tableConditionList});break;default:break}}),e.forEach(t=>{s.push({from:""+t.sourceEle,to:""+t.targetEle})}),i}function H(t,e,i){const a=[],s=e.filter(e=>e.to==t);return s?(s.forEach(t=>{const e=i.find(e=>e.id==t.from);e&&e.field.forEach(t=>{let i=0;"right"==e.rightOrLeft&&(i=1),"left"==e.rightOrLeft&&(i=0),a.push({...t,tempId:parseInt(t.id),fromEleId:parseInt(t.fromEleId),type:i})})}),a):a}function V(t){const{nodeList:e,lineList:i}=t,a=[];return e.forEach(t=>{let s=0,n=t.condition,o=null,l=null;switch(t.type){case"table":s=0;break;case"calculators":"并集"==t.name&&(s=2),"交集"==t.name&&(s=3),o=H(t.id,i,e),l=t.sourceMap?M(t.sourceMap):[];break;case"export":s=1;break;default:break}a.push({tempId:parseInt(t.id),type:s,metaTableId:parseInt(t.tableId),x:parseFloat(t.left),y:parseFloat(t.top),daCoRelColContentList:o,daCoRelColRelationList:l,tableConditionList:n})}),a}function q(t,e){if(t===e)return!0;if("object"===typeof t&&null!=t&&"object"===typeof e&&null!=e){if(Object.keys(t).length!=Object.keys(e).length)return!1;for(var i in t){if(!e.hasOwnProperty(i))return console.log(i),!1;if(!q(t[i],e[i]))return console.log(i),!1}return!0}return console.log(i),!1}function Z(){for(var t=["0","1","2","3","4","5","6","7","8","9"],e="",i=0;i<9;i++){var a=parseInt(9*Math.random()+1);e+=t[a]}return e}async function J(t,e){return new Promise(async(i,a)=>{const s=[];try{const{data:a}=await D({tableId:t}),{list:n}=a;n.forEach(t=>{s.push({id:Z(),name:t.name,tableId:t.tableId,rename:t.name,typeValue:t.typeValue,isExportItem:!1,isOutputCol:!1,tableUUId:e,colLength:t.colLength,decimalLength:t.decimalLength,fromEleId:e})}),i(s)}catch(n){a(n)}})}var U,W,Y=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"collision-canvas",staticStyle:{display:"flex","justify-content":"space-between"}},[i("div",[i("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.sourceLoading,expression:"sourceLoading"}],ref:"tableSource",style:[{width:t.tableWidth+"rem",float:"left"}],attrs:{data:t.sourceFiledList,"header-cell-class-name":"headerCss",border:""}},t._l(t.sourceTableHeader,(function(e,a){return i("el-table-column",{key:e.prop,attrs:{label:e.label},scopedSlots:t._u([{key:"default",fn:function(a){return[i("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:a.row[e.prop],placement:"top-start"}},[i("span",{staticClass:"edit-label"},[t._v(t._s(a.row[e.prop]))])]),i("span",{staticClass:"edit-iconfont"},[i("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:"输出字段",placement:"top"}},[i("i",{class:{"el-icon-export-icon":a.row.isOutputCol,"el-icon-no-export-icon":!a.row.isOutputCol},on:{click:function(e){return t.chooseIsExport(a.row,"source")}}})])],1)]}}],null,!0)})})),1)],1),t.sourceTableSameTargetTable?t._e():i("canvas",{attrs:{id:t.canvasId,width:"0",height:"0"}}),i("div",[i("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.targetLoading,expression:"targetLoading"}],ref:"tableTarget",style:"width: "+t.tableWidth+"rem",attrs:{data:t.targetFiledList,"header-cell-class-name":"headerCss",border:""}},t._l(t.targetTableHeader,(function(e,a){return i("el-table-column",{key:e.prop,attrs:{label:e.label,"show-overflow-tooltip":""},scopedSlots:t._u([{key:"default",fn:function(a){return[i("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:a.row[e.prop],placement:"top-start"}},[i("span",{staticClass:"edit-label"},[t._v(t._s(a.row[e.prop]))])]),i("span",{staticClass:"edit-iconfont"},[i("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:"输出字段",placement:"top"}},[i("i",{class:{"el-icon-export-icon":a.row.isOutputCol,"el-icon-no-export-icon":!a.row.isOutputCol},on:{click:function(e){return t.chooseIsExport(a.row,"target")}}})])],1)]}}],null,!0)})})),1)],1)])},X=[],G={name:"table-and-canvas",props:{tableWidth:{type:String,default:"4"},canvasId:{type:String,default:"are"},isUpdate:{type:Boolean,default:!0},sourceTableSameTargetTable:{type:Boolean,default:!1},targetLoading:{type:Boolean,default:!1},sourceLoading:{type:Boolean,default:!1},displayAutoSort:{type:Boolean,default:!0},sourceFiledList:{type:Array,default:function(){return[]}},targetFiledList:{type:Array,default:function(){return[]}},relList:{type:Array,default:function(){return[]}},colRelList:{type:Array,default:function(){return[]}},sourceTableHeader:{type:Array,default:function(){return[{prop:"name",label:"字段名称"}]}},targetTableHeader:{type:Array,default:function(){return[{prop:"name",label:"字段名称"}]}},canvasWidth:{type:Number,default:159}},data(){return{gap:54,gapFloat:.3,ctx:"",canvas:"",srcPoints:"",tarPoints:"",startP:"",endP:"",formCheckResult:[],currentRow:{},itemName:""}},mounted(){},methods:{resizeMethods(t){this.$nextTick(()=>{const e=this.sourceFiledList.length,i=this.targetFiledList.length;let a;a=e>i?this.$refs.tableSource.$el.offsetHeight:this.$refs.tableTarget.$el.offsetHeight;let s=document.getElementById(this.canvasId);const n=Math.max(e,i);this.gap=a/(n+1),s.height=n*this.gap+this.gap;const{width:o}=s.parentNode.getBoundingClientRect(),{width:l}=s.parentNode.childNodes[0].getBoundingClientRect();s.width=o-2*l,this.linePoint(t)})},constructor(t,e,i,a,s=7.5,n="#DDDDDD"){return{id:t,x:e,y:i,flag:a,r:s,color:n}},copy(t,e,i,a){let s=this.constructor(t,e,i);return s.color="#2d78f4",s},chooseIsExport(t,e){if("target"==e){const e=this.colRelList.find(e=>e.targetColId==t.id);if(e){const i=this.sourceFiledList.find(t=>t.id==e.sourceColId);if(t.isOutputCol)return this.$message.error("映射字段必须选择一个字段为输出字段");i.isOutputCol?(i.isOutputCol=!1,t.isOutputCol=!0,this.$emit("update:exportHeader",{node:i,status:!1}),this.$emit("update:exportHeader",{node:t,status:!0})):(t.isOutputCol=!0,this.$emit("update:exportHeader",{node:t,status:!0}))}else t.isOutputCol=!t.isOutputCol,this.$emit("update:exportHeader",{node:t,status:t.isOutputCol})}else{const e=this.colRelList.find(e=>e.sourceColId==t.id);if(e){const i=this.targetFiledList.find(t=>t.id==e.targetColId);if(t.isOutputCol)return this.$message.error("必须选择一个字段为输出字段");i.isOutputCol?(i.isOutputCol=!1,this.$emit("update:exportHeader",{node:i,status:!1}),t.isOutputCol=!0,this.$emit("update:exportHeader",{node:t,status:!0})):(t.isOutputCol=!0,this.$emit("update:exportHeader",{node:t,status:!0}))}else t.isOutputCol=!t.isOutputCol,this.$emit("update:exportHeader",{node:t,status:t.isOutputCol})}},autoSort_click(t){let e=[],i=[],a=[],s=[];const n=this.sourceFiledList,o=this.targetFiledList;if(1===t){this.relList&&(this.changeColRelList("all",[]),this.relList.forEach((t,e)=>{const i=0==t.start.id,a=i?"yyyy-MM-dd HH:mm:ss":"";this.changeColRelList("push",{isSourceTimeCol:i,sourceColId:t.start.id,targetColId:t.end.id,timeFormat:a,sequenceNo:t.sequence})}));for(let t=0;t<this.relList.length;t++)for(let i=0;i<n.length;i++)this.relList[t].start.id==n[i].id&&e.push(n[i]);i=n.filter(t=>!e.some(e=>e.id==t.id));for(let t=0;t<this.relList.length;t++)for(let e=0;e<o.length;e++)this.relList[t].end.id==o[e].id&&a.push(o[e]);s=o.filter(t=>!a.some(e=>e.id==t.id))}else if(2===t){for(let t=0;t<this.colRelList.length;t++)for(let i=0;i<n.length;i++)this.colRelList[t].sourceColId==n[i].id&&e.push(n[i]);i=n.filter(t=>!e.some(e=>e.id==t.id));for(let t=0;t<this.colRelList.length;t++)for(let e=0;e<o.length;e++)this.colRelList[t].targetColId==o[e].id&&a.push(o[e]);s=o.filter(t=>!a.some(e=>e.id==t.id))}this.resizeMethods(t),this.$emit("changeFiledList",{source:e.concat(i),target:a.concat(s)})},linePoint(t){this.canvas=document.getElementById(this.canvasId),this.ctx=this.canvas.getContext("2d");let e=this.canvas.width,i=(this.canvas.height,this.colRelList);this.changeRelList("all",[]);let a=this.sourceFiledList,s=this.targetFiledList,n=(Math.max(a.length,s.length),this.gap);this.srcPoints=[],a.forEach((t,e)=>{let i=this.constructor(t["id"],parseFloat(this.gapFloat*n),parseFloat((e+1.5)*n),0);this.srcPoints.push(i)}),this.tarPoints=[],s.forEach((t,i)=>{let a=this.constructor(t["id"],parseFloat(e-this.gapFloat*n),parseFloat((i+1.5)*n),1);this.tarPoints.push(a)}),i.forEach(t=>{try{this.srcPoints.forEach(e=>{if(t["sourceColId"]==e.id){let i=this.copy(e.id,e.x,e.y);i.color="#2d78f4",this.tarPoints.forEach(e=>{if(t["targetColId"]==e.id){let a=this.copy(e.id,e.x,e.y);a.color="#2d78f4";let s={start:i,end:a,sequence:t["sequenceNo"]};throw this.changeRelList("push",s),new Error("ending")}})}})}catch(e){if("ending"==e.message)return}}),this.startP=null,this.endP=null,this.redraw(),this.isUpdate&&(this.canvas.addEventListener("mousedown",t=>{this.detect(t)}),this.canvas.addEventListener("mouseup",t=>{this.reset(t)}),this.canvas.addEventListener("mousemove",t=>{this.dragLine(t)}),this.canvas.addEventListener("dblclick",t=>{this.quitRels(t)}))},redraw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawPoints(this.srcPoints.concat(this.tarPoints)),this.startP&&this.drawPoint(this.startP),this.endP&&this.drawPoint(this.endP),this.relList.length>0&&this.drawRelList(this.relList)},drawPoints(t){t.forEach(t=>{this.drawPoint(t)})},drawPoint({x:t,y:e,r:i,color:a}){this.ctx&&("#DDDDDD"==a?(this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fillStyle="#DDDDDD",this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t,e,i-1,0,2*Math.PI),this.ctx.fillStyle="#fff",this.ctx.fill()):(this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fillStyle="#1890FF",this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t,e,i-1,0,2*Math.PI),this.ctx.fillStyle="#fff",this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t,e,i-4,0,2*Math.PI),this.ctx.fillStyle="#1890FF",this.ctx.fill()))},drawLine(t,e){this.drawArrow(this.ctx,t.x,t.y,e.x,e.y,30,10,1,"#1890FF")},calDistance(t,e){return((t.x-e.x)**2+(t.y-e.y)**2)**.5},detect(t){var e=t.clientX-this.canvas.getBoundingClientRect().left,i=t.clientY-this.canvas.getBoundingClientRect().top;let a=this.constructor(0,e,i);this.srcPoints.concat(this.tarPoints).forEach(t=>{this.calDistance(t,a)<t.r&&(0==t.flag?this.startP=this.copy(t.id,t.x,t.y):this.endP=this.copy(t.id,t.x,t.y))})},reset(){this.startP=null,this.endP=null,this.redraw()},dragLine(t){var e=t.clientX-this.canvas.getBoundingClientRect().left,i=t.clientY-this.canvas.getBoundingClientRect().top;let a=this.constructor(0,e,i);if(this.startP)return this.tarPoints.forEach(t=>{this.startP&&this.calDistance(this.startP,a)>t.r&&this.calDistance(t,a)<t.r&&(this.endP=this.copy(t.id,t.x,t.y),this.endP.color="#2d78f4",this.saveRel())}),this.redraw(),void(this.startP&&this.drawLine(this.startP,a));this.endP&&(this.srcPoints.forEach(t=>{this.endP&&this.calDistance(this.endP,a)>t.r&&this.calDistance(t,a)<t.r&&(this.startP=this.copy(t.id,t.x,t.y),this.startP.color="#2d78f4",this.saveRel())}),this.redraw(),this.endP&&this.drawLine(a,this.endP))},async saveRel(){let t=this.copy(this.startP.id,this.startP.x,this.startP.y),e=this.copy(this.endP.id,this.endP.x,this.endP.y);for(let n=0;n<this.relList.length;n++)if(this.relList[n]["start"].id==this.startP.id||this.relList[n]["end"].id==this.endP.id)return this.endP=null,void(this.startP=null);let i={start:t,end:e,sequence:this.relList.length};if(JSON.stringify(this.relList).indexOf(`"id":${e.id},`)>-1)return;this.changeRelList("push",i),this.changeColRelList("all",[]),this.relList.forEach(t=>{this.changeColRelList("push",{sourceColId:t.start.id,targetColId:t.end.id})}),await this.$nextTick();const a=this.sourceFiledList.find(e=>e.id==t.id),s=this.targetFiledList.find(t=>t.id==e.id);s.isOutputCol&&(a.rename=s.rename),a.isOutputCol&&(s.rename=a.rename),s.isOutputCol||a.isOutputCol||(a.isOutputCol=!0,this.$emit("update:exportHeader",{node:a,status:!0}),s.rename=a.rename),this.$emit("update:targetFiledList",this.targetFiledList),this.$emit("update:sourceFiledList",this.sourceFiledList)},drawRelList(){this.relList.forEach(t=>{this.drawPoint(t.start),this.drawPoint(t.end),this.drawLine(t.start,t.end)})},changeRelList(t,e){let i=this.relList;switch(t){case"push":i.push(e);break;case"pop":i.pop();break;case"set":if("object"===typeof e){let{i:t,temp:a}=e;this.$set(i,t,a)}break;case"all":i.splice(0);break;default:break}this.$emit("update:relList",i)},changeColRelList(t,e){let i=this.colRelList;switch(t){case"push":const t=this.sourceFiledList.find(t=>t.id==e.sourceColId),a=this.targetFiledList.find(t=>t.id==e.targetColId);a.isOutputCol&&t.isOutputCol&&(a.isOutputCol=!1,this.$emit("update:exportHeader",{node:a,status:!1})),a.isOutputCol||t.isOutputCol||(t.isOutputCol=!0,this.$emit("update:exportHeader",{node:t,status:!0})),a.isOutputCol&&(t.rename=a.rename),t.isOutputCol&&(a.rename=t.rename),this.$emit("update:targetFiledList",this.targetFiledList),this.$emit("update:sourceFiledList",this.sourceFiledList),i.push(e);break;case"all":i.splice(0);break}this.$emit("update:colRelList",i)},quitRels(t){var e=t.clientX-this.canvas.getBoundingClientRect().left,i=t.clientY-this.canvas.getBoundingClientRect().top;let a=this.constructor(0,e,i);this.srcPoints.concat(this.tarPoints).forEach(t=>{if(this.calDistance(t,a)<t.r){console.log(0==t.flag?"源表id "+t.id:"目的表id "+t.id);for(let e=0;e<this.relList.length;e++)if(0==t.flag){if(this.relList[e]["start"].id==t.id){console.log("源表id "+t.id,"映射关系 ",this.relList[e]["start"].id),this.resetOutputCol(this.relList[e]["start"].id,this.relList[e]["end"].id);let i=this.relList[this.relList.length-1];this.changeRelList("set",{i:e,temp:i}),this.changeRelList("pop"),e--}}else if(this.relList[e]["end"].id==t.id){console.log("目的表id "+t.id,"映射关系 ",this.relList[e]["end"].id),this.resetOutputCol(this.relList[e]["start"].id,this.relList[e]["end"].id);let i=this.relList[this.relList.length-1];this.changeRelList("set",{i:e,temp:i}),this.changeRelList("pop"),e--}}}),this.reset(),this.changeColRelList("all",[]),this.relList.forEach(t=>{this.changeColRelList("push",{sourceColId:t.start.id,targetColId:t.end.id})})},async resetOutputCol(t,e){const i=this.sourceFiledList.find(e=>e.id==t),a=this.targetFiledList.find(t=>t.id==e);i.isOutputCol=!1,a.isOutputCol=!1,await this.$emit("update:exportHeader",{node:i,status:!1}),await this.$emit("update:exportHeader",{node:a,status:!1}),i.rename=i.name,a.rename=a.name,this.$emit("update:targetFiledList",this.targetFiledList),this.$emit("update:sourceFiledList",this.sourceFiledList)},drawArrow(t,e,i,a,s,n,o,l,r){n="undefined"!==typeof n?n:30,o="undefined"!==typeof n?o:10,l="undefined"!==typeof l?l:1,r="color"!==typeof r?r:"#000";var c=180*Math.atan2(i-s,e-a)/Math.PI,d=(c+n)*Math.PI/180,u=(c-n)*Math.PI/180,h=o*Math.cos(d),p=o*Math.sin(d),f=o*Math.cos(u),m=o*Math.sin(u);this.ctx.save(),this.ctx.beginPath();var v=e-h,g=i-p;this.ctx.moveTo(v,g),this.ctx.moveTo(e,i),this.ctx.lineTo(a,s),v=a+h,g=s+p,this.ctx.moveTo(v,g),this.ctx.lineTo(a,s),v=a+f,g=s+m,this.ctx.lineTo(v,g),this.ctx.strokeStyle=r,this.ctx.lineWidth=l,this.ctx.stroke(),this.ctx.restore()}}},K=G,Q=(i("2476"),Object(m["a"])(K,Y,X,!1,null,null,null)),tt=Q.exports,et=Object(N["defineComponent"])({name:"calculator-dialog",props:{calculatorDialogVisible:{type:Boolean,default:!1},status:{type:Number,default:null},data:{type:Object,default:function(){return{}}}},setup(t,{emit:e,parent:i,refs:s}){Object(N["onMounted"])(()=>{f.value=s.tableAndCanvas||null,a["default"].nextTick(()=>{f.value=s.tableAndCanvas||null})}),Object(N["onUpdated"])(()=>{f.value=s.tableAndCanvas||null,a["default"].nextTick(()=>{f.value=s.tableAndCanvas||null})});const n=Object(N["ref"])([]),o=Object(N["ref"])([]),l=Object(N["ref"])(null),r=Object(N["ref"])([]),c=Object(N["ref"])([]),d=Object(N["ref"])([]),u=Object(N["ref"])(JSON.parse(JSON.stringify(t.data))),h=Object(N["ref"])(!1),p=Object(N["ref"])(!1),f=Object(N["ref"])(null),m=()=>{e("update:calculatorDialogVisible",!1),e("cancel")},v=async()=>{if(0==r.value.length)return S["Message"].error("必须选择一个映射关系");let i=!1;t.data.result.sourceMap&&t.data.result.sourceMap.length>0&&!q(t.data.result.sourceMap,r.value)&&(i=!0);let a=!1;if(t.data.result.sourceMap&&t.data.result.sourceMap.length>0&&t.data.table[0].field.length>0&&t.data.table[1].field.length){const e=t.data.table.find(t=>"left"==t.rightOrLeft),i=t.data.table.find(t=>"right"==t.rightOrLeft);q(e.field,c.value)||(a=!0),q(i.field,d.value)||(a=!0)}if(i||a)try{S["MessageBox"].confirm("修改中间的映射关系和输出字段将影响到后边的所有连线","提示",{type:"warning",cancelButtonText:"取消",confirmButtonText:"确定",beforeClose:(t,i,a)=>{"confirm"===t?(e("confirm",{changeStatus:!0,colRelList:r.value,sourceFiledList:c.value,targetFiledList:d.value}),a()):a()}})}finally{}else e("confirm",{changeStatus:!1,colRelList:r.value,sourceFiledList:c.value,targetFiledList:d.value})},g=async t=>{h.value=!0;try{t.tableId?(c.value=await J(t.tableId,t.id),await i.$nextTick()):(c.value=[].concat(t.field),await i.$nextTick()),await y(),h.value=!1}catch(e){h.value=!1,S["Message"].error("查询表字段接口报错！")}},b=async t=>{p.value=!0;try{t.tableId?(d.value=await J(t.tableId,t.id),await i.$nextTick()):(d.value=[].concat(t.field),await i.$nextTick()),await y(),p.value=!1}catch(e){p.value=!1,S["Message"].error("查询表字段接口报错！")}},L=async()=>{Object.values(u.value.table).forEach(async(t,e)=>{null==t.rightOrLeft?0==e?await g(t):await b(t):("left"==t.rightOrLeft?c.value=[...t.field]:"right"==t.rightOrLeft&&(d.value=[...t.field]),y())}),await i.$nextTick();const t=[];c.value.forEach(e=>{e.isOutputCol&&t.push({relationTempId:e.id,name:e.rename,isShowInput:!1,rename:e.rename})}),d.value.forEach(e=>{e.isOutputCol&&t.push({relationTempId:e.id,name:e.rename,isShowInput:!1,rename:e.rename})}),n.value=t},y=()=>{u.value.result.sourceMap?(r.value=u.value.result.sourceMap,C(),n.value=u.value.result.field):f.value.autoSort_click(2)},C=t=>{f.value.resizeMethods(t)},w=t=>{o.value=t},k=t=>{r.value=t},T=()=>{o.value.splice(0)},x=t=>{d.value=t},I=t=>{c.value=t},O=({node:t,status:e})=>{if(e)n.value.push({name:t.rename,rename:t.rename,isShowInput:!1,relationTempId:t.id});else{const e=n.value.findIndex(e=>e.relationTempId==t.id);e>=0&&n.value.splice(e,1)}},_=({source:t,target:e})=>{c.value=t,d.value=e,c.value=i.$removeRepeat(c.value,"id"),d.value=i.$removeRepeat(d.value,"id")},P=async(t,e)=>{switch(t){case 0:n.value.forEach(t=>{t.isShowInput=!1}),await i.$nextTick(),l.value=e.rename,e.isShowInput=!0;break;case 1:let t=d.value.find(t=>t.id==e.relationTempId);if(t){const e=r.value.find(e=>e.targetColId==t.id);if(e){const t=c.value.find(t=>t.id==e.sourceColId);t.rename=l.value}t.rename=l.value}else if(t=c.value.find(t=>t.id==e.relationTempId),t){const e=r.value.find(e=>e.sourceColId==t.id);if(e){const t=d.value.find(t=>t.id==e.targetColId);t.rename=l.value}t.rename=l.value}e.rename=l.value,e.isShowInput=!1;break;case 2:l.value=null,e.isShowInput=!1;break}};return Object(N["watch"])(f,async()=>{f.value&&u.value.table.length>0&&L()}),Object(N["onMounted"])(()=>{}),()=>Object(N["h"])(S["Dialog"],{on:{close:m},attrs:{closeOnClickModal:!1,visible:t.calculatorDialogVisible},class:"calculator-dialog"},[Object(N["h"])("module-title",{slot:"title"},["设置关联关系"]),Object(N["h"])("div",{class:"calculator-dialog__content "+(t.status?"readOnly":null)},[Object(N["h"])("section",[Object(N["h"])("module-title",{class:"calculator-dialog__content-title"},[Object(N["h"])("span",["配置字段"]),Object(N["h"])(S["Tooltip"],{class:"item",attrs:{effect:"light",placement:"top-start"}},[Object(N["h"])("div",{slot:"content"},["1.每个数据碰撞算子至少需要存在一组关联字段；",Object(N["h"])("br"),"2.选中的关联字段组将默认作为一个输出字段进行输出"]),Object(N["h"])("span",{class:"set-notice"},[Object(N["h"])("i",{class:"el-icon-question"}),"配置说明"])])]),Object(N["h"])("div",{class:"calculator-dialog__content-canvas"},[Object(N["h"])(tt,{on:{cleanRelList:T,changeFiledList:_,resizeMethods:C,"update:relList":w.bind(null),"update:colRelList":k.bind(null),"update:exportHeader":O.bind(null),"update:targetFiledList":x.bind(null),"update:sourceFiledList":I.bind(null)},attrs:{relList:o.value,colRelList:r.value,tableWidth:"2.3",sourceLoading:h.value,sourceFiledList:c.value,targetLoading:p.value,targetFiledList:d.value},ref:"tableAndCanvas"})])]),Object(N["h"])("section",[Object(N["h"])("module-title",{class:"calculator-dialog__content-title"},["输出预览"]),Object(N["h"])("div",{class:"export-table el-table el-table--small",attrs:{height:60}},[Object(N["h"])("div",{class:"el-table__header-wrapper"},[Object(N["h"])("table",{class:"el-table__header"},[Object(N["h"])("thead",[Object(N["h"])("tr",[Object.entries(n.value).map(([,e])=>{const{name:i,rename:s,isShowInput:n}=e;return Object(N["h"])("th",[Object(N["h"])("div",{class:"cell"},[!n&&[Object(N["h"])(S["Tooltip"],{class:"item",attrs:{effect:"light",content:i,placement:"top-start"}},[Object(N["h"])("span",{class:"edit-label"},[s])]),!t.status&&Object(N["h"])(S["Tooltip"],{class:"item",attrs:{effect:"light",content:"编辑名称",placement:"top"}},[Object(N["h"])("i",{on:{click:P.bind(null,0,e)},class:"el-icon-edit"})])],n&&Object(N["h"])(S["Input"],{class:"edit-table-item-name",on:{blur:P.bind(null,2,e)},nativeOn:{keyup:t=>{"Enter"===t.key&&P(1,e)}},model:{value:l.value,callback:t=>{a["default"].set(l,"value",t)}}},[Object(N["h"])(S["Button"],{on:{click:P.bind(null,1,e)},slot:"append",attrs:{icon:"el-icon-success"}}),Object(N["h"])(S["Button"],{on:{click:P.bind(null,2,e)},slot:"append",attrs:{icon:"el-icon-circle-close"}})])])])})])])])])])])]),Object(N["h"])("div",{slot:"footer"},[Object(N["h"])(S["Button"],{on:{click:m}},["取 消"]),Object(N["h"])(S["Button"],{attrs:{type:"primary"},on:{click:v}},["提 交"])])])}}),it=et,at=(i("c86a"),Object(m["a"])(it,U,W,!1,null,"66ff80ca",null)),st=at.exports,nt=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"tool",staticClass:"flow-menu"},[i("el-input",{ref:"condition",staticClass:"condition",attrs:{"suffix-icon":"el-icon-search",placeholder:"请输入关键字，按“Enter”键查找"},nativeOn:{keyup:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter"))return null;t.params.page=1,t.searchResult()}},model:{value:t.params.condition,callback:function(e){t.$set(t.params,"condition",e)},expression:"params.condition"}}),i("el-collapse",{staticClass:"el-data-collision-menu",attrs:{accordion:""},model:{value:t.currentMenu,callback:function(e){t.currentMenu=e},expression:"currentMenu"}},t._l(t.menuList,(function(e,a){return i("el-collapse-item",{key:a,staticClass:"el-data-collision-submenu",attrs:{name:""+a}},[i("template",{slot:"title"},[i("span",{staticClass:"node-pmenu"},[i("i",{staticClass:"el-icon el-data-collision-database"}),i("span",[t._v(t._s(e.name+"（"+e.children.length+"）"))])])]),i("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"menu.loading"}],staticClass:"el-collapse-item__content-box"},[e.children.length>0?t._l(e.children,(function(e,s){return i("draggable",{key:s,attrs:{draggable:t.status?null:".node-menu-li",options:t.draggableOptions},on:{end:t.end}},[i("div",{staticClass:"node-menu-li",class:t.status?"readOnly":"",attrs:{type:e.type,menuIndex:s,index:a+"-"+s}},[i("i",{staticClass:"el-icon el-data-collision-table"}),i("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:e.name,placement:"top-start"}},[i("span",{staticClass:"el-data-collision-submenu__table-name"},[t._v(t._s(e.name))])]),i("i",{staticClass:"el-line"})],1)])})):t._e(),0!=e.children.length||e.loading?t._e():[i("div",{staticClass:"no-data"},[t._v("暂无数据")])]],2)],2)})),1)],1)},ot=[];const lt={nodeList:[],lineList:[]},rt={1:"分",2:"时",3:"天",4:"周",5:"月"},ct={preventOnFilter:!1,sort:!1,disabled:!1,ghostClass:"tt",forceFallback:!0},dt=[{label:"交集",name:"intersection",type:"calculators",icon:"result-component__icon-jiao"},{label:"并集",name:"union",type:"calculators",icon:"result-component__icon-bing"},{label:"输出",name:"export",type:"export",icon:"result-component__icon-export"}];var ut,ht,pt={left:-1,top:-1},ft={name:"node-menu",props:["status"],data(){return{draggableOptions:ct,currentMenu:"0",params:{page:"",size:"",condition:""},menuList:[{id:"1",type:"database",name:"系统标准库",loading:!1,ico:"el-data-collision-database",children:[]}]}},components:{draggable:c.a},created(){this.isFirefox()&&(document.body.ondrop=function(t){pt.left=t.layerX,pt.top=t.clientY-50,t.preventDefault(),t.stopPropagation()})},mounted(){this.searchResult()},methods:{async searchResult(){this.menuList[0].loading=!0,this.menuList[0].children=[];try{const{data:t}=await T(this.params);console.log(t);const{list:e}=t;e.forEach(t=>{this.menuList[0].children.push({name:t.dbTableName,tableId:t.id,type:"table"})}),await this.$nextTick(),this.menuList[0].loading=!1}catch(t){this.$message.error("查询系统标准库报错！"),console.log(t)}},end(t){let e={};const i=t.item.menuIndex||t.item.getAttribute("menuIndex"),a=t.item.type||t.item.getAttribute("type");switch(a){case"table":const t=this.menuList.find(t=>"database"===t.type);t&&(e={tableId:t.children[i].tableId,name:t.children[i].name,type:t.children[i].type});break}this.$emit("addNode",t,e)},isFirefox(){var t=navigator.userAgent;return t.indexOf("Firefox")>-1}}},mt=ft,vt=(i("42c6"),Object(m["a"])(mt,nt,ot,!1,null,null,null)),gt=vt.exports,bt=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"task-list"},[a("div",{staticClass:"panel__title"},[a("span",[t._v("任务列表（"+t._s(t.taskData.length)+"/10）")]),a("span",{staticClass:"icon-box"},[a("i",{staticClass:"el-icon-refresh-left",on:{click:function(e){return t.getTaskList()}}}),a("i",{staticClass:"el-data-collision-task",on:{click:function(e){return t.searchNoRunTask()}}})])]),t.noRunTaskVisible?t._e():a("div",{staticClass:"task-container"},[a("el-input",{ref:"condition",attrs:{"suffix-icon":"el-icon-search",placeholder:"请输入关键字，按“Enter”键查找"},nativeOn:{keyup:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter"))return null;t.params.page=1,t.getTaskList()}},model:{value:t.params.condition,callback:function(e){t.$set(t.params,"condition",e)},expression:"params.condition"}}),a("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"task-container__list"},[t.taskData&&t.taskData.length>0?t._l(t.taskData,(function(e,i){return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"task.loading"}],key:i,staticClass:"task-container__item",class:{"is-active":t.activeJobId==e.id},on:{click:function(a){return a.target!==a.currentTarget?null:t.previewTask(e,i)}}},[a("div",{staticClass:"task-container__item-title"},[a("i",{class:{"el-success-task":2==e.status,"el-error-task":2!=e.status},on:{click:function(a){return a.target!==a.currentTarget?null:t.previewTask(e,i)}}}),a("span",{staticClass:"task-container__item-name",on:{click:function(a){return a.target!==a.currentTarget?null:t.previewTask(e,i)}}},[t._v(t._s(e.name))]),a("span",{class:"task-container__item-status task_"+e.status,on:{click:function(a){return a.target!==a.currentTarget?null:t.previewTask(e,i)}}},[t._v(" "+t._s(e.statusString)+" ")]),a("el-dropdown",{attrs:{trigger:"click"},on:{command:function(i){return t.handleCommand(i,e.id)}}},[a("span",{staticClass:"el-dropdown-link"},[a("i",{staticClass:"el-icon-more"})]),a("el-dropdown-menu",{staticClass:"task-container__item-action",attrs:{slot:"dropdown"},slot:"dropdown"},[1==e.status||e.isRepeat&&2==e.status?a("el-dropdown-item",{attrs:{command:"2",icon:"el-icon-video-pause"}},[t._v("中止")]):t._e(),a("el-dropdown-item",{attrs:{command:"3",icon:"el-icon-delete"}},[t._v("删除")])],1)],1)],1)])})):t._e(),t.taskData&&0!=t.taskData.length||t.loading?t._e():[a("img",{staticClass:"not-find-img",attrs:{src:i("49d2")}})]],2)],1),a("div",{staticClass:"no-run-list",class:t.noRunTaskVisible?"active":""},[a("div",{staticClass:"panel__title"},[a("span",[a("i",{staticClass:"el-icon-arrow-left",on:{click:function(e){return t.resetParams()}}}),t._v("已保存方案")]),a("span",{staticClass:"icon-box"},[a("i",{staticClass:"el-icon-refresh-left",on:{click:function(e){return t.getTaskList()}}})])]),a("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"task-container__list"},[t.taskData&&t.taskData.length>0?t._l(t.taskData,(function(e,i){return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"task.loading"}],key:i,staticClass:"task-container__item",class:{"is-active":t.activeJobId==e.id},on:{click:function(a){return a.target!==a.currentTarget?null:t.previewTask(e,i)}}},[a("div",{staticClass:"task-container__item-title"},[a("i",{staticClass:"el-no-run-task",on:{click:function(a){return a.target!==a.currentTarget?null:t.previewTask(e,i)}}}),a("span",{staticClass:"task-container__item-name",on:{click:function(a){return a.target!==a.currentTarget?null:t.previewTask(e,i)}}},[t._v(t._s(e.name))]),a("el-dropdown",{attrs:{trigger:"click"},on:{command:function(i){return t.handleCommand(i,e.id)}}},[a("span",{staticClass:"el-dropdown-link"},[a("i",{staticClass:"el-icon-more"})]),a("el-dropdown-menu",{staticClass:"task-container__item-action",attrs:{slot:"dropdown"},slot:"dropdown"},[a("el-dropdown-item",{attrs:{command:"3",icon:"el-icon-delete"}},[t._v("删除")])],1)],1)],1)])})):t._e(),t.taskData&&0!=t.taskData.length||t.loading?t._e():[a("img",{staticClass:"not-find-img",attrs:{src:i("49d2")}})]],2)])])},Lt=[],yt={name:"task-list",props:{activeJobId:{type:String,default:""},canvasLoading:{type:Boolean,default:!1},tabs:{type:Array,default:function(){return[]}}},data(){return{loading:!1,timingTypeString:rt,total:0,taskData:null,noRunTaskVisible:!1,params:{taskStatus:1,condition:""}}},async created(){this.getTaskList()},methods:{async handleCommand(t,e){const i=this.tabs.find(t=>t.id==e);switch(t){case"1":this.$emit("runTaskAction",e);break;case"2":try{const{data:t}=await P(e);"NORMAL"==t?this.$message.success("中止成功"):this.$message.error("中止失败！"),this.getTaskList()}catch(a){this.$message.error("中止失败！"),console.log(a)}break;case"3":i&&this.$emit("removeRepeatTaskTab",e),this.deleteTask(e);break;default:break}},async deleteTask(t){try{const{data:e}=await _(t);this.$message.success("删除成功"),this.getTaskList()}catch(e){this.$message.error("删除失败！"),console.log(e)}},parentPreviewTask(t){const e=this.taskData.findIndex(e=>e.id==t);this.previewTask(this.taskData[e],e)},async previewTask({id:t,status:e,name:i,loading:a,startTime:s,endTime:n},o){if(5==this.tabs.length)return this.$message.error("一次只能打开5个任务！");this.$set(this.taskData,o,{...this.taskData[o],loading:!0});const l=this.tabs.find(e=>e.id==t);if(l){if(l.status==e)return!1,this.$set(this.taskData,o,{...this.taskData[o],loading:!1}),this.$emit("changeTab",t);this.$emit("removeRepeatTaskTab",t)}this.$emit("update:canvasLoading",!0);try{const{data:i}=await j(t),{resultTableData:a,log:l}=i;this.$emit("previewTask",{id:t,jobContent:i.flow,log:l,status:e,resultData:a?{...a,loadingTime:s&&n?((new Date(s).getTime()-new Date(n).getTime())/1e3).toFixed(2):null,tableName:i.flow.resultTableName||"暂无"}:null}),this.$set(this.taskData,o,{...this.taskData[o],loading:!1}),console.log(i)}catch(r){this.$set(this.taskData,o,{...this.taskData[o],loading:!1}),this.$emit("update:canvasLoading",!1),this.$message.error("获取任务信息失败！"),console.log(r)}},resetParams(){this.params.taskStatus=1,this.getTaskList(),this.noRunTaskVisible=!1},async getTaskList(){this.taskData=[],this.loading=!0;const{data:t}=await O(this.params);t.forEach(t=>{let e=t.status;const i=this.getStatusString(e);null!=t.status&&(1==this.params.taskStatus?t.status>0&&this.taskData.push({...t,loading:!1,status:e,statusString:i}):this.taskData.push({...t,loading:!1,status:e,statusString:i}))}),1==this.params.taskStatus&&""==this.params.condition&&this.$emit("updateTaskTotal",t.length),this.loading=!1},getStatusString(t){let e="";switch(t){case 1:e="执行中";break;case 2:e="执行成功";break;case 3:e="执行失败";break;case 4:e="已中止";break;default:break}return e},searchNoRunTask(){this.params.taskStatus=0,this.params.condition="",this.getTaskList(),this.noRunTaskVisible=!0}}},Ct=yt,wt=(i("0aaf"),Object(m["a"])(Ct,bt,Lt,!1,null,"6506a285",null)),kt=wt.exports,Tt=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"node",class:[t.node.type].concat(t.nodeContainerClass),style:t.nodeContainerStyle,on:{dblclick:function(e){e.stopPropagation(),e.preventDefault(),!t.isOnlyTooltip&&t.openPreview()},click:function(e){e.stopPropagation(),e.preventDefault(),!t.isOnlyTooltip&&t.openPreview()},mouseup:function(e){!t.isOnlyTooltip&&t.changeNodeSite()},mousemove:function(e){!t.isOnlyTooltip&&t.mouseMove()},mousedown:function(e){!t.isOnlyTooltip&&t.mouseDown()}}},[i("div",{staticClass:"table-title",on:{dblclick:function(e){e.stopPropagation(),e.preventDefault(),!t.isOnlyTooltip&&t.openPreview()},click:function(e){e.stopPropagation(),e.preventDefault(),!t.isOnlyTooltip&&t.openPreview()}}},[t.isOnlyTooltip?t._e():i("div",{staticClass:"node-left-ico"},[i("i",{class:[{"result-component__icon-jiao":"交集"==t.node.name},{"result-component__icon-bing":"并集"==t.node.name},{"result-component__icon-export":"输出"==t.node.name},{"el-data-collision-table":"table"==t.node.type}]})]),i("div",{staticClass:"node-label",attrs:{"show-overflow-tooltip":!0}},[t._v(" "+t._s(t.node.name)+" ")]),"export"==t.node.type||t.isOnlyTooltip?t._e():i("div",{staticClass:"flow-node-drag"}),t.isHasRedMark?i("el-tooltip",{staticClass:"item",attrs:{effect:"light",placement:"bottom",content:"连接后需设置关联关系"}},[i("i",{staticClass:"el-icon-warning node-label__red-mark",staticStyle:{cursor:"pointer",color:"#F56C6C",position:"absolute",bottom:"1px"}})]):t._e(),!t.isCanDelete||t.isOnlyTooltip||t.status?t._e():i("div",{staticClass:"node-right-ico"},[i("i",{staticClass:"el-icon-error",on:{click:function(e){return e.stopPropagation(),e.preventDefault(),t.deleteElement(e)}}})])],1),t.node.condition&&t.node.condition.length>0&&"table"==t.node.type?i("div",{staticClass:"table-condition"},[t._l(t.node.condition.filter((function(t){return 3==t.whereType||3!=t.whereType&&(t.contentStart||t.contentEnd)})),(function(e,a){return[t.isOnlyTooltip||!t.isOnlyTooltip&&a<2?i("div",{key:e.columnName,staticClass:"table-condition__item"},[i("label",{staticClass:"el-label"},[t._v(t._s(e.colmunName)+"：")]),i("div",{staticClass:"table-condition__item-result"},[3==e.whereType?[t._v(" 为空值 ")]:2==e.whereType?[t._v(" "+t._s("大于"+e.contentStart+",小于"+e.contentEnd)+" ")]:[t._v(" "+t._s(e.contentStart)+" ")]],2)]):t._e()]}))],2):t._e()])},xt=[],It={name:"flow-node",props:{node:Object,data:Object,isActiveTab:Boolean,status:Number,isOnlyTooltip:{type:Boolean,default:!1},activeElement:Object},data(){return{whereTypeMapping:{0:"精确查询",1:"模糊查询",2:"范围查询",3:"空值查询"},isCanDelete:!0,clickFlag:!1,isHasRedMark:!1}},created(){const t=this.data.lineList.find(t=>t.from==this.node.id);this.isCanDelete=!t},watch:{node:{handler(){"calculators"==this.node.type?null!==this.node.sourceMap?this.isHasRedMark=!1:this.isHasRedMark=!0:this.isHasRedMark=!1},deep:!0},data:{handler(){const t=this.data.lineList.find(t=>t.from==this.node.id);this.isCanDelete=!t,"calculators"==this.node.type?null!==this.node.sourceMap?this.isHasRedMark=!1:this.isHasRedMark=!0:this.isHasRedMark=!1},deep:!0}},computed:{nodeContainerClass(){return this.isOnlyTooltip?{"node-tooltip-container":!0}:{"node-container":!0,"node-active":"node"==this.activeElement.type&&this.activeElement.nodeId===this.node.id}},nodeContainerStyle(){return this.isOnlyTooltip?{}:{top:this.node.top,left:this.node.left}}},methods:{async deleteElement(){this.$emit("clickNode",{id:this.node.id,type:this.node.type}),await this.$nextTick(),this.$emit("deleteElement")},async openPreview(){this.clickNode(),await this.$nextTick(),this.clickFlag&&this.$emit("openPreview")},clickNode(){this.$emit("clickNode",{id:this.node.id,tableId:this.node.tableId||null,type:this.node.type})},mouseDown(){this.clickFlag=!0},mouseMove(){this.clickFlag=!1},changeNodeSite(){this.node.left==this.$refs.node.style.left&&this.node.top==this.$refs.node.style.top||this.$emit("changeNodeSite",{nodeId:this.node.id,left:this.$refs.node.style.left,top:this.$refs.node.style.top})}}},Ot=It,_t=(i("d55f"),Object(m["a"])(Ot,Tt,xt,!1,null,"34ca84ee",null)),Pt=_t.exports,jt=Object(N["defineComponent"])({name:"flow-node",props:{node:{type:Object,default:function(){return{}}},data:{type:Object,default:function(){return{}}},activeElement:{type:Object,default:function(){return{}}},status:{type:Number,default:null}},setup(t,{emit:e,parent:i}){const a=()=>{e("clickNode",t.node)},s=()=>{e("deleteElement")},n=()=>{e("changeNodeSite",t.data)},o=()=>{e("openPreview")};return()=>Object(N["h"])("div",["table"==t.node.type&&Object(N["h"])(S["Tooltip"],{attrs:{placement:"top",effect:"dark","popper-class":"container_node-tooltip"}},[Object(N["h"])("div",{slot:"content"},[Object(N["h"])(Pt,{attrs:{id:t.node.id,isOnlyTooltip:!0,data:t.data,node:t.node,status:t.status,activeElement:t.activeElement}})]),Object(N["h"])(Pt,{attrs:{id:t.node.id,data:t.data,node:t.node,status:t.status,activeElement:t.activeElement},on:{deleteElement:s,changeNodeSite:n,openPreview:o,clickNode:a}})]),"table"!=t.node.type&&Object(N["h"])(Pt,{attrs:{id:t.node.id,data:t.data,node:t.node,status:t.status,activeElement:t.activeElement},on:{deleteElement:s,changeNodeSite:n,openPreview:o,clickNode:a}})])}}),Dt=jt,Et=Object(m["a"])(Dt,ut,ht,!1,null,null,null),St=Et.exports,$t={name:"panel",mixins:[E],data(){var t=async(t,e,i)=>{const a=new RegExp('[`////:*?\\\\<>"|]');e&&a.test(e)?i(new Error('任务名称不能包含 / : * ? " <> | 这些在特殊符号')):i()};return{nameValidateForm:{name:""},canvasLoading:!1,editCanvasNamePopover:!1,calculators:dt,draggableOptions:ct,jsPlumb:d["jsPlumb"],rules:{name:[{required:!0,message:"请输入任务名称",trigger:"blur"},{max:10,message:"长度在10个字符",trigger:"blur"},{validator:t,required:!0,trigger:"blur"}]},loadEasyFlowFinish:!1,activeElement:{type:void 0,nodeId:void 0,sourceId:void 0,targetId:void 0},panelContainerStyle:{width:"calc(100vw - 320px - 360px)"},canvasActiveId:"",canvasTabList:[],dataInit:lt,calculatorDialogVisible:!1,calculatorDialogData:null,jobId:null,isCanClear:!1,isShowNewTaskNotice:!0,isCanZoomAdd:!0,isCanZoomMinus:!0,isFullScreen:!1,taskTotal:0,isShowNodeMenu:!0,isShowTaskList:!1,isShowErrorLogDrawer:!0,isShowResultDataDrawer:!0,isFirstSave:!1}},components:{Drawer:g,flowNode:St,nodeMenu:gt,taskList:kt,draggable:c.a,calculatorDialog:st},directives:{flowDrag:{bind(t,e){e&&(t.onmousedown=e=>{if(2==e.button)return;let i=e.clientX,a=e.clientY,s=t.firstChild.offsetLeft,n=t.firstChild.offsetTop;t.style.cursor="move",document.onmousemove=function(e){e.preventDefault();const o=e.clientX-(i-s),l=e.clientY-(a-n);t.firstChild.style.left=o+"px",t.firstChild.style.top=l+"px"},document.onmouseup=function(e){t.style.cursor="auto",document.onmousemove=null,document.onmouseup=null}})}}},watch:{async canvasActiveId(t,e){if(t!=e&&(await this.$nextTick(),!this.isFirstSave))if(this.canvasActiveId)this.editCanvasNamePopover=!1,this.resetCanvasData();else if(0==this.canvasTabList.length)return this.isCanClear=!1,void(this.isShowNewTaskNotice=!0)}},async mounted(){window.onresize=()=>{this.jsPlumb.setSuspendDrawing(!1,!0)}},methods:{mouseWheelAction(t){const e=t.deltaY,i=this.canvasTabList.findIndex(t=>t.id==this.canvasActiveId);if(this.canvasTabList[i].zoom<=.1&&e>0)return void(this.isCanZoomMinus=!1);if(this.canvasTabList[i].zoom>=4&&e<0)return void(this.isCanZoomAdd=!1);let a=this.canvasTabList[i].zoom;a+=-.01*e,a=Math.min(Math.max(.1,a),4),a<=.1&&(this.isCanZoomMinus=!1),a>=4&&(this.isCanZoomAdd=!1),this.isCanZoomAdd=!0,this.isCanZoomMinus=!0,this.$set(this.canvasTabList,i,{...this.canvasTabList[i],zoom:a}),this.jsPlumb.setZoom(a)},openTaskList(){this.$refs.taskList.resetParams()},async toggleEditCanvasNamePopover(t){this.editCanvasNamePopover=!this.editCanvasNamePopover,await this.$nextTick(),1==this.editCanvasNamePopover&&(this.nameValidateForm.name=t)},async closeAllTab(){this.isFirstSave=!1;let t=!1;this.canvasTabList.forEach(e=>{t=e.status||q(e.data,e.deepCloneData)?t||!1:t||!0}),await this.$nextTick(),t?this.$confirm("刚刚修改的内容未保存，全部关闭将丢失！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.canvasTabList=[],this.canvasActiveId=null,this.isCanClear=!1,this.isShowNewTaskNotice=!0}):(this.canvasTabList=[],this.canvasActiveId=null,this.isCanClear=!1,this.isShowNewTaskNotice=!0)},async resetFlowContainer(){let{data:t,id:e}=this.canvasTabList.find(t=>t.id==this.canvasActiveId),i=this.canvasTabList.findIndex(t=>t.id==this.canvasActiveId);this.$set(this.canvasTabList,i,{...this.canvasTabList[i],zoom:1}),this.jsPlumb.setZoom(1),await this.$nextTick();const a=this.$refs["flowContainer_"+e][0];a.style.top=0,a.style.left=0;a.getBoundingClientRect();this.getTreeConstruction(t,e)},async getTreeConstruction(t,e){const i=new Set;t.lineList.forEach(t=>{i.add(t.to)});for(let o of i.values()){const e=t.lineList.find(t=>t.from==o);e&&i.delete(o)}if(i.size&&i.size>1||!i)return this.$message.error("请连接完整！");const a=[...i][0],s=t.nodeList.find(t=>t.id==a);s.level=1,s.sort=1;const n={id:a,children:[],levelCount:1,level:1};n.children=this.getChildrenById(a,t,1,1),this.changeNodePosition(t,s.level,e,0),await this.$nextTick(),this.jsPlumb.setSuspendDrawing(!1,!0)},changeNodePosition(t,e,i,a){const s=350,n=65,o=70,l=20,r=40,c=o+2*l,d=s+2*r,u=n+2*r,h=this.$refs["flowContainer_"+i][0],{width:p,height:f}=h.getBoundingClientRect(),m=t.nodeList.filter(t=>t.level==e),v=m.length;if(0==v)return;let g=u+a;const b=m.find(t=>"table"==t.type);b&&(g=d+a),m.forEach(async t=>{let e=0;if(v%2){const i=parseInt(v/2)+1;e=f/2-c/2-(i-t.sort)*c+l}else{const i=parseInt(v/2);e=f/2-(i-t.sort+1)*c+l}const i=p-g+r;t.top=e+"px",t.left=i+"px",await this.$nextTick()}),this.changeNodePosition(t,e+1,i,g)},getChildrenById(t,e,i,a){const s=[],n=e.lineList.filter(e=>e.to==t);return n&&(i+=1,n.forEach((t,n)=>{const o=e.nodeList.find(e=>e.id==t.from),l=n+1+2*(a-1);let r=this.getChildrenById(t.from,e,i,l);o.level=i,o.sort=l,s.push({id:t.from,level:i,children:r,levelCount:0})})),s},zoomAdd(){let t=this.canvasTabList.findIndex(t=>t.id==this.canvasActiveId);this.canvasTabList[t].zoom>.1&&(this.isCanZoomMinus=!0),this.canvasTabList[t].zoom>=4?this.isCanZoomAdd=!1:(this.isCanZoomAdd=!0,this.$set(this.canvasTabList,t,{...this.canvasTabList[t],zoom:this.canvasTabList[t].zoom+.1}),this.jsPlumb.setZoom(this.canvasTabList[t].zoom))},zoomMinus(){let t=this.canvasTabList.findIndex(t=>t.id==this.canvasActiveId);this.canvasTabList[t].zoom<4&&(this.isCanZoomAdd=!0),this.canvasTabList[t].zoom<=.1?this.isCanZoomMinus=!1:(this.isCanZoomMinus=!0,this.$set(this.canvasTabList,t,{...this.canvasTabList[t],zoom:this.canvasTabList[t].zoom-.1}),this.jsPlumb.setZoom(this.canvasTabList[t].zoom))},changeTab(t){const e=this.canvasTabList.find(e=>e.id==t);e&&(this.isFirstSave=!1,this.canvasActiveId=""+t)},async resetCanvasData(){if(this.isFullScreen=!1,0==this.canvasTabList.length)return this.isCanClear=!1,void(this.isShowNewTaskNotice=!0);const{status:t,id:e,data:i}=this.canvasTabList.find(t=>t.id==this.canvasActiveId);this.isCanClear=null==t,null==t&&0==i.nodeList.length?this.isShowNewTaskNotice=!0:this.isShowNewTaskNotice=!1,this.jobId=""+e,await this.$nextTick(),this.dataReload()},updateTaskTotal(t){this.taskTotal=t},setCondition({condition:t,tempId:e}){const{data:i}=this.canvasTabList.find(t=>t.id==this.canvasActiveId),a=i.nodeList.find(t=>t.id==e);a.condition=t},async previewTaskDetail({id:t,jobContent:e,log:i,status:a,resultData:s}){const n=this.canvasTabList.find(e=>e.id==t);if(n)return this.$message.error("已经打开过了！");this.jobId=""+t;const o=B(e);this.canvasTabList.push({name:e.name,status:a,id:t,zoom:1,data:o,log:i,deepCloneData:JSON.parse(JSON.stringify(o)),resultTableData:s}),this.isFirstSave=!1,this.canvasActiveId=""+t,await this.$nextTick(),this.canvasLoading=!1},judgeConditionComplete(t){return new Promise(e=>{t.nodeList.forEach(t=>{t.condition&&t.condition.length>0&&t.condition.forEach(t=>{3==t.whereType||t.contentStart||t.contentEnd||e("筛选条件必须输入内容！")})}),e()})},async clearCanvas(){const{data:t,status:e}=this.canvasTabList.find(t=>t.id==this.canvasActiveId);t.lineList=[],t.nodeList=[],this.jsPlumb.deleteEveryConnection(),this.jsPlumb.deleteEveryEndpoint(),this.isShowNewTaskNotice=null==e,this.dataReload()},handleCanvasNamePopover(t){this.nameValidateForm.name=t},getUUID(){for(var t=["0","1","2","3","4","5","6","7","8","9"],e="",i=0;i<9;i++){var a=parseInt(9*Math.random()+1);e+=t[a]}return e},async createAction(){return new Promise(async t=>{const e=this.canvasTabList.find(t=>t.id==this.canvasActiveId),i={name:e.name,elementList:V(e.data),elementRelList:R(e.data.lineList)};try{if(0==e.status){this.isFirstSave=!1;const{data:t}=await I({...i,id:e.id});e.id=t}else{this.isFirstSave=!0;const{data:t}=await x(i);e.id=t,e.status=0,this.canvasActiveId=""+t}await this.$nextTick(),e.data=JSON.parse(JSON.stringify(e.data)),e.deepCloneData=JSON.parse(JSON.stringify(e.data)),this.$message.success("保存方案成功！"),t(e.id)}catch(a){t(a),console.log(a),this.$message.error("保存方案失败！")}})},async handleCalculatorData({colRelList:t,sourceFiledList:e,targetFiledList:i,changeStatus:a}){const s=this.canvasTabList.find(t=>t.id==this.canvasActiveId);if(!this.activeElement)return;const n=s.data.nodeList.find(t=>t.id==this.activeElement.nodeId);n.sourceMap=t;const o=s.data.lineList.filter(t=>t.to==this.activeElement.nodeId);if(!(o.length<2)){if(o.forEach(t=>{let a=s.data.nodeList.findIndex(e=>e.id==t.from),n=s.data.nodeList[a];null==n.rightOrLeft?n.id==e[0].fromEleId?(n.field=e,n.rightOrLeft="left"):n.id==i[0].fromEleId&&(n.field=i,n.rightOrLeft="right"):"right"==n.rightOrLeft?this.$set(s.data.nodeList,a,{...n,rightOrLeft:"right",field:[...i]}):this.$set(s.data.nodeList,a,{...n,rightOrLeft:"left",field:[...e]})}),await this.$nextTick(),a){const t=this.jsPlumb.getConnections(),e=this.getParentNodes(n.id,s.data.lineList);t&&e&&e.forEach(e=>{const i=t.find(t=>t.sourceId==e);this.jsPlumb.deleteConnection(i)})}this.calculatorDialogVisible=!1}},getParentNodes(t,e,i=[]){const a=e.find(e=>e.from==t);if(a){i.push(t);const s=e.find(e=>e.to==a.to&&e.from!=t);s&&i.push(s.from),this.getParentNodes(a.to,[...e],i)}return i},endCalculators(t){const e=this.calculators[t.newDraggableIndex],i={ico:e.icon,name:e.label,tableId:e.tableId||null,type:e.type};this.addNode(t,i)},async loadEasyFlow(){const{data:t,status:e}=this.canvasTabList.find(t=>t.id==this.canvasActiveId);if(!e)for(var i=0;i<t.nodeList.length;i++){let e=t.nodeList[i];this.jsPlumb.makeSource(""+e.id,this.jsplumbSourceOptions),this.jsPlumb.makeTarget(""+e.id,this.jsplumbTargetOptions),this.jsPlumb.draggable(""+e.id,{containment:!1,stop:function(){console.log("---------拖完了")},drag:()=>{this.jsPlumb.repaintEverything()}})}for(i=0;i<t.lineList.length;i++){let e=t.lineList[i];var a={source:""+e.from,target:""+e.to,label:e.label?e.label:"",connector:e.connector?e.connector:"",anchors:e.anchors?e.anchors:void 0,paintStyle:e.paintStyle?e.paintStyle:void 0};this.jsPlumb.connect(a,this.jsplumbConnectOptions)}console.log(this.jsPlumb.getAllConnections()),this.$nextTick((function(){this.loadEasyFlowFinish=!0}))},isShowDelete(t){const e=document.createElement("i");return t||(e.setAttribute("class","el-icon-error line-delete"),e.setAttribute("style","color:#FF0000")),e},jsPlumbInit(){const t=this.canvasTabList.find(t=>t.id==this.canvasActiveId);this.jsPlumb.ready(async()=>{this.jsPlumb.importDefaults({...this.jsplumbSetting,ConnectionOverlays:[["Custom",{create:()=>this.isShowDelete(t.status),location:.5}]],Container:"flowContainer_"+t.id}),this.jsPlumb.setSuspendDrawing(!1,!0),this.loadEasyFlow(),this.jsPlumb.bind("click",t=>{this.activeElement.type="line",this.activeElement.sourceId=t.sourceId,this.activeElement.targetId=t.targetId,this.deleteElement()}),this.jsPlumb.bind("connection",t=>{console.warn("在连接线");let e=t.source.id,i=t.target.id;if(this.loadEasyFlowFinish){const{data:t}=this.canvasTabList.find(t=>t.id==this.canvasActiveId);t.lineList.push({from:e,to:i}),this.lineComplete(e,i)}}),this.jsPlumb.bind("connectionDetached",async e=>{console.log("删除连线回调"),t.status||e.sourceId&&e.targetId&&await this.deleteLine(e.sourceId,e.targetId)}),this.jsPlumb.bind("connectionMoved",t=>{this.changeLine(t.originalSourceId,t.originalTargetId)}),this.jsPlumb.bind("contextmenu",t=>{console.log("contextmenu",t)}),this.jsPlumb.bind("beforeDrop",t=>{const e=t.sourceId,i=t.targetId;if(e===i)return this.$message.error("节点不支持连接自己"),!1;if(this.hasLine(e,i))return this.$message.error("该关系已存在,不允许重复创建"),!1;if(this.hashOppositeLine(e,i))return this.$message.error("不支持两个节点之间连线回环"),!1;if(this.judgeIsTableLink(e,i))return this.$message.error("不支持两个表之间互相连接"),!1;const a=this.canvasTabList.find(t=>t.id==this.canvasActiveId),s=a.data.nodeList.find(t=>t.id==e),n=a.data.nodeList.find(t=>t.id==i),o=a.data.lineList.filter(t=>t.to==i&&t.from!=e);if(o&&2==o.length)return this.$message.error("一个算子只能连接两个表"),!1;if("table"==n.type)return this.$message.error("表不能被连接！"),!1;if("calculators"==s.type){const t=a.data.lineList.filter(t=>t.to==e);if(t.length<2)return this.$message.error("算子没有连接完整！"),!1;const i=[];t.forEach(t=>{const e=a.data.nodeList.find(e=>e.id==t.from);e.field.forEach(t=>{t.isOutputCol&&i.push({name:t.rename,rename:t.rename,id:this.getUUID(),isOutputCol:!1,isShowInput:!1,tableUUId:s.id,fromEleId:s.id})})}),s.field=i}return"export"!=n.type||"table"!=s.type||(this.$message.error("表不能直接连接输出"),!1)}),this.jsPlumb.bind("beforeDetach",t=>{console.warn("beforeDetach",t)}),this.jsPlumb.setContainer(this.$refs["flowContainer_"+t.id][0])})},async deleteLine(t,e){const{data:i}=this.canvasTabList.find(t=>t.id==this.canvasActiveId);if(0==i.nodeList.length)return;if(0==i.lineList.length)return;const a=i.nodeList.find(t=>t.id==e);if(a&&"export"!==a.type){const s=i.nodeList.find(e=>e.id==t),n=i.lineList.find(i=>i.from!=t&&i.to==e);if(await this.resetNodeData(s),await this.resetNodeData(a,!0),n){const t=i.nodeList.find(t=>t.id==n.from);await this.resetNodeData(t)}}await this.$nextTick(),i.lineList=i.lineList.filter(i=>i.from!==t||i.to!==e)},hasLine(t,e){const{data:i}=this.canvasTabList.find(t=>t.id==this.canvasActiveId);for(var a=0;a<i.lineList.length;a++){var s=i.lineList[a];if(s.from===t&&s.to===e)return!0}return!1},async lineComplete(t,e){const{data:i}=this.canvasTabList.find(t=>t.id==this.canvasActiveId),a=i.nodeList.find(t=>t.id==e);if("calculators"==a.type){if(this.clickNode({id:a.id,type:a.type}),await this.$nextTick(),this.calculatorDialogData=this.getCalculatorDialogData(a.id),!this.calculatorDialogData)return;await this.$nextTick(),this.calculatorDialogVisible=!0}},hashOppositeLine(t,e){return this.hasLine(e,t)},judgeIsTableLink(t,e){const{data:i}=this.canvasTabList.find(t=>t.id==this.canvasActiveId);let a=!1;const s=i.nodeList.find(e=>e.id==t),n=i.nodeList.find(t=>t.id==e);return"table"==s.type&&"table"==n.type&&(a=!0),a},deleteElement(){const t=this.canvasTabList.find(t=>t.id==this.canvasActiveId);t.status||("line"===this.activeElement.type?this.$confirm("确定删除所点击的线吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{if(this.isHaveParent(this.activeElement.targetId))return this.$message.error("不能删除有父节点的连线！");const e=t.data.nodeList.find(t=>t.id==this.activeElement.sourceId);this.resetNodeData(e);const i=t.data.nodeList.find(t=>t.id==this.activeElement.targetId);"calculators"==i.type?this.resetNodeData(i,!0):this.resetNodeData(i);var a=this.jsPlumb.getConnections({source:this.activeElement.sourceId,target:this.activeElement.targetId})[0];this.jsPlumb.deleteConnection(a)}).catch(()=>{}):this.deleteNode(this.activeElement.nodeId))},isHaveParent(t){let e=!1;const i=this.canvasTabList.find(t=>t.id==this.canvasActiveId),a=i.data.lineList.find(e=>e.from==t);return a&&(e=!0),e},deleteNode(t){const e=this.canvasTabList.find(t=>t.id==this.canvasActiveId),{lineList:i}=e.data,a=i.find(e=>e.from==t);if(a)return this.$message.error("不能删除子节点！");const s=e.data.nodeList.find(e=>e.id==t);return this.$confirm("确定要删除节点"+s.name+"?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",closeOnClickModal:!1}).then(()=>{this.deleteRelationNode(t),e.data.nodeList=e.data.nodeList.filter(e=>e.id!==t),null==e.status&&0==e.data.nodeList.length?this.isShowNewTaskNotice=!0:this.isShowNewTaskNotice=!1,e.data.lineList=e.data.lineList.filter(e=>e.from!==t&&e.to!==t),this.$nextTick((function(){this.jsPlumb.removeAllEndpoints(t)}))}).catch(()=>{}),!0},deleteRelationNode(t){const e=this.canvasTabList.find(t=>t.id==this.canvasActiveId),i=e.data.lineList.filter(e=>e.to==t);i.forEach(t=>{const i=e.data.nodeList.find(e=>e.id==t.from);this.resetNodeData(i)})},resetNodeData(t,e=!1){return t.field.length>0&&t.field.forEach(t=>{t.rename=t.name,t.isOutputCol=!1}),t.rightOrLeft=null,e&&(t.sourceMap=null),t},async addNode(t,e){0==this.canvasTabList.length&&this.addTab(),await this.$nextTick();const i=this.canvasTabList.find(t=>t.id==this.canvasActiveId);let a=t.originalEvent.clientX,s=t.originalEvent.clientY;const n=this.$refs["flowContainer_"+i.id][0],o=n.parentNode.getBoundingClientRect();let l=a,r=s;if("export"==e.type){const t=i.data.nodeList.find(t=>"export"==t.type);if(t)return void this.$message.error("画布中已经存在输出节点了，不能重复拖拽")}if(l<o.x||l>o.width+o.x||r<o.y||o.y>o.y+o.height)return void this.$message.error("请把节点拖入到画布中");l-=o.x,r-=o.y,"table"==e.type?(l-=100,r-=15):(l-=30,r-=30);const c=o.height/i.zoom-o.height,d=o.width/i.zoom-o.width;r=r/i.zoom-c/2-parseFloat(n.style.top||0)/i.zoom,l=l/i.zoom-d/2-parseFloat(n.style.left||0)/i.zoom;const u=this.getUUID();var h={id:""+u,name:e.name,tableId:e.tableId||null,type:e.type,left:l+"px",top:r+"px",ico:e.ico,state:"success",field:[],condition:null,rightOrLeft:null,sourceMap:null};this.isShowNewTaskNotice&&(this.isShowNewTaskNotice=!1),i.data.nodeList.push(h),this.$nextTick((function(){this.jsPlumb.makeSource(u,this.jsplumbSourceOptions),this.jsPlumb.makeTarget(u,this.jsplumbTargetOptions),this.jsPlumb.draggable(""+h.id,{containment:!1,stop:function(){console.log("---------拖完了")},drag:()=>{this.jsPlumb.repaintEverything()}})})),this.clickNode({id:h.id,type:h.type})},nodeRightMenu(t,e){this.menu.show=!0,this.menu.curNodeId=t,this.menu.left=e.x+"px",this.menu.top=e.y+"px"},changeNodeSite(t){const e=this.canvasTabList.find(t=>t.id==this.canvasActiveId);for(var i=0;i<e.data.nodeList.length;i++){let a=e.data.nodeList[i];a.id===t.nodeId&&(a.left=t.left,a.top=t.top)}},clickNode({id:t,type:e,tableId:i}){this.activeElement={type:e,nodeId:t,tableId:i}},getCalculatorDialogData(t){const e=this.canvasTabList.find(t=>t.id==this.canvasActiveId),i=e.data.lineList.filter(e=>e.to==t);if(i.length<2)return!1;const a={table:[],result:null};return a.result=e.data.nodeList.find(e=>e.id==t),i.forEach(t=>{const i=e.data.nodeList.find(e=>e.id==t.from);a.table.push({...i})}),a},async dataReload(){this.jsPlumb=d["jsPlumb"].getInstance(),await this.$nextTick(),d["jsPlumb"].repaintEverything(),this.jsPlumbInit()},addTab(){if(5==this.canvasTabList.length)return this.$message.error("一次只能打开5个任务！");const t=(""+(new Date).getTime()).substring(5);let e="任务"+t;this.dataInit;const i=this.getUUID();this.canvasTabList.push({name:e,id:i,status:null,zoom:1,log:null,deepCloneData:{nodeList:[],lineList:[]},resultTableData:null,data:{nodeList:[],lineList:[]}}),this.isFirstSave=!1,this.canvasActiveId=""+i},async removeRepeatTaskTab(t=null,e=null){let i=null;null!=e&&(i=e),null!=t&&(i=this.canvasTabList.findIndex(e=>e.id==t));const a=this.canvasTabList[i].id==this.canvasActiveId,s=i;await this.$nextTick();const n=this.canvasTabList[s-1]?""+this.canvasTabList[s-1].id:null,o=this.canvasTabList[s+1]?""+this.canvasTabList[s+1].id:null;this.canvasTabList.splice(i,1),this.isFirstSave=!1,a&&(this.canvasTabList.length>0?this.canvasActiveId=n||o:this.canvasActiveId=null)},removeTab(t){const e=this.canvasTabList[t];e&&(e.status||q(e.data,e.deepCloneData)?this.removeRepeatTaskTab(null,t):this.$confirm("是否确定要关闭这个画布?","",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{this.removeRepeatTaskTab(null,t)}))},editCanvasName(t){this.$refs.rulesForm[0].validate(e=>{if(!e)return!1;{const e=this.canvasTabList.find(t=>t.name==this.nameValidateForm.name);if(e)return this.$message.error("任务名称重复！");const i=this.canvasTabList[t];i.name=this.nameValidateForm.name,this.editCanvasNamePopover=!1,this.resetCanvasData()}})}}},Nt=$t,Ft=(i("ce7c"),i("b457"),Object(m["a"])(Nt,o,l,!1,null,"bc5fd9b0",null)),Rt=Ft.exports,Mt={name:"App",components:{PanelIndex:Rt}},At=Mt,zt=(i("5c0b"),Object(m["a"])(At,s,n,!1,null,null,null)),Bt=zt.exports;i("0fae");a["default"].use($.a,{size:"small"}),a["default"].use(F.a),i("245a"),a["default"].config.productionTip=!1,new a["default"]({render:t=>t(Bt)}).$mount("#app")},"5c0b":function(t,e,i){"use strict";var a=i("9c0c"),s=i.n(a);s.a},"7f9f":function(t,e,i){},"9c0c":function(t,e,i){},b457:function(t,e,i){"use strict";var a=i("4a4d"),s=i.n(a);s.a},b68b:function(t,e,i){},b7d3:function(t,e,i){},c86a:function(t,e,i){"use strict";var a=i("b7d3"),s=i.n(a);s.a},ce7c:function(t,e,i){"use strict";var a=i("3724"),s=i.n(a);s.a},d55f:function(t,e,i){"use strict";var a=i("7f9f"),s=i.n(a);s.a},eb88:function(t,e,i){},f4f4:function(t,e,i){"use strict";var a=i("b68b"),s=i.n(a);s.a}});